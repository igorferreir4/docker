version: 2.1

executors:
  machine-executor-amd64:
    machine:
      image: ubuntu-2204:current
    resource_class: medium

  machine-executor-arm64:
    machine:
      image: ubuntu-2204:current
    resource_class: arm.medium

parameters:
  build-and-push:
    type: boolean
    default: false
  run-all:
    type: boolean
    default: false

commands:
  dockerhub-login:
    steps:
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin

  setup-qemu:
    steps:
      - run:
          name: Setup Qemu
          command: |
            docker run --privileged --rm tonistiigi/binfmt --install all
      - run:
          name: Create builder
          command: |
            docker buildx create --name multi-arch-build --bootstrap --use
      - dockerhub-login

jobs:
  build-cache-amd64:
    executor: machine-executor-amd64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_TAG: traefik-http-provider-1.0.0-amd64
      CACHE_TAG_OLD: traefik-http-provider-1.0.0-amd64
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - dockerhub-login
      - run:
          name: Build docker image (amd64 cache)
          command: |
            docker buildx inspect amd64-builder > /dev/null 2>&1 || docker buildx create --use --name amd64-builder --driver docker-container
            docker buildx build \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_TAG_OLD" \
              --cache-from="$CACHE_REPO:$CACHE_TAG" \
              --cache-to=type=registry,ref=$CACHE_REPO:$CACHE_TAG,mode=max \
              --platform=linux/amd64 \
              .

  build-cache-arm64:
    executor: machine-executor-arm64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_TAG: traefik-http-provider-1.0.0-arm64
      CACHE_TAG_OLD: traefik-http-provider-1.0.0-arm64
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - dockerhub-login
      - run:
          name: Build docker image (arm64 cache)
          command: |
            docker buildx inspect arm64-builder > /dev/null 2>&1 || docker buildx create --use --name arm64-builder --driver docker-container
            docker buildx build \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_TAG_OLD" \
              --cache-from="$CACHE_REPO:$CACHE_TAG" \
              --cache-to=type=registry,ref=$CACHE_REPO:$CACHE_TAG,mode=max \
              --platform=linux/arm64/v8 \
              .

  build-multi-arch:
    executor: machine-executor-amd64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_AMD64: traefik-http-provider-1.0.0-amd64
      CACHE_ARM64: traefik-http-provider-1.0.0-arm64
      IMAGE_REPO: igorferreir4/traefik-http-provider
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - setup-qemu
      - run:
          name: Load version
          command: |
            echo "export IMAGE_VERSION=$(cat VERSION)" >> "$BASH_ENV"
      - run:
          name: Build and push multi-arch image
          command: |
            IMAGE_TAGS="${IMAGE_VERSION},latest"
            EFFECTIVE_TAGS="$IMAGE_TAGS"
            if [ "$CIRCLE_BRANCH" != "main" ] && [ -n "$CIRCLE_BRANCH" ]; then
              EFFECTIVE_TAGS=$(echo "$IMAGE_TAGS" | tr "," "\n" | grep -v '^latest$' | paste -sd "," -)
            fi

            TAGS=""
            for tag in $(echo "$EFFECTIVE_TAGS" | tr "," " "); do
              TAGS="$TAGS -t $IMAGE_REPO:$tag"
            done
            
            echo "Building tags: $TAGS"
            
            docker buildx build \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_AMD64" \
              --cache-from="$CACHE_REPO:$CACHE_ARM64" \
              --push \
              --platform=linux/amd64,linux/arm64/v8 \
              $TAGS .
      - run:
          name: Verify pushed images
          command: |
            echo "Verifying images were pushed successfully..."
            IMAGE_TAGS="${IMAGE_VERSION},latest"
            EFFECTIVE_TAGS="$IMAGE_TAGS"
            if [ "$CIRCLE_BRANCH" != "main" ] && [ -n "$CIRCLE_BRANCH" ]; then
              EFFECTIVE_TAGS=$(echo "$IMAGE_TAGS" | tr "," "\n" | grep -v '^latest$' | paste -sd "," -)
            fi

            for tag in $(echo "$EFFECTIVE_TAGS" | tr "," " "); do
              echo "Checking $IMAGE_REPO:$tag"
              docker manifest inspect $IMAGE_REPO:$tag > /dev/null
              if [ $? -eq 0 ]; then
                echo "✓ $IMAGE_REPO:$tag exists"
              else
                echo "✗ $IMAGE_REPO:$tag not found"
                exit 1
              fi
            done

  build-cache-amd64-alpine:
    executor: machine-executor-amd64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_TAG: traefik-http-provider-1.0.0-amd64-alpine
      CACHE_TAG_OLD: traefik-http-provider-1.0.0-amd64-alpine
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - dockerhub-login
      - run:
          name: Build docker image (amd64 alpine cache)
          command: |
            docker buildx inspect amd64-alpine-builder > /dev/null 2>&1 || docker buildx create --use --name amd64-alpine-builder --driver docker-container
            docker buildx build \
              -f Dockerfile.alpine \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_TAG_OLD" \
              --cache-from="$CACHE_REPO:$CACHE_TAG" \
              --cache-to=type=registry,ref=$CACHE_REPO:$CACHE_TAG,mode=max \
              --platform=linux/amd64 \
              .

  build-cache-arm64-alpine:
    executor: machine-executor-arm64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_TAG: traefik-http-provider-1.0.0-arm64-alpine
      CACHE_TAG_OLD: traefik-http-provider-1.0.0-arm64-alpine
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - dockerhub-login
      - run:
          name: Build docker image (arm64 alpine cache)
          command: |
            docker buildx inspect arm64-alpine-builder > /dev/null 2>&1 || docker buildx create --use --name arm64-alpine-builder --driver docker-container
            docker buildx build \
              -f Dockerfile.alpine \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_TAG_OLD" \
              --cache-from="$CACHE_REPO:$CACHE_TAG" \
              --cache-to=type=registry,ref=$CACHE_REPO:$CACHE_TAG,mode=max \
              --platform=linux/arm64/v8 \
              .

  build-multi-arch-alpine:
    executor: machine-executor-amd64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_AMD64: traefik-http-provider-1.0.0-amd64-alpine
      CACHE_ARM64: traefik-http-provider-1.0.0-arm64-alpine
      IMAGE_REPO: igorferreir4/traefik-http-provider
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - setup-qemu
      - run:
          name: Load version
          command: |
            echo "export IMAGE_VERSION=$(cat VERSION)" >> "$BASH_ENV"
      - run:
          name: Build and push multi-arch image
          command: |
            IMAGE_TAGS="${IMAGE_VERSION}-alpine,latest-alpine"
            EFFECTIVE_TAGS="$IMAGE_TAGS"
            if [ "$CIRCLE_BRANCH" != "main" ] && [ -n "$CIRCLE_BRANCH" ]; then
              EFFECTIVE_TAGS=$(echo "$IMAGE_TAGS" | tr "," "\n" | grep -v '^latest-alpine$' | paste -sd "," -)
            fi

            TAGS=""
            for tag in $(echo "$EFFECTIVE_TAGS" | tr "," " "); do
              TAGS="$TAGS -t $IMAGE_REPO:$tag"
            done
            
            echo "Building tags: $TAGS"
            
            docker buildx build \
              -f Dockerfile.alpine \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_AMD64" \
              --cache-from="$CACHE_REPO:$CACHE_ARM64" \
              --push \
              --platform=linux/amd64,linux/arm64/v8 \
              $TAGS .
      - run:
          name: Verify pushed images
          command: |
            echo "Verifying images were pushed successfully..."
            IMAGE_TAGS="${IMAGE_VERSION}-alpine,latest-alpine"
            EFFECTIVE_TAGS="$IMAGE_TAGS"
            if [ "$CIRCLE_BRANCH" != "main" ] && [ -n "$CIRCLE_BRANCH" ]; then
              EFFECTIVE_TAGS=$(echo "$IMAGE_TAGS" | tr "," "\n" | grep -v '^latest-alpine$' | paste -sd "," -)
            fi

            for tag in $(echo "$EFFECTIVE_TAGS" | tr "," " "); do
              echo "Checking $IMAGE_REPO:$tag"
              docker manifest inspect $IMAGE_REPO:$tag > /dev/null
              if [ $? -eq 0 ]; then
                echo "✓ $IMAGE_REPO:$tag exists"
              else
                echo "✗ $IMAGE_REPO:$tag not found"
                exit 1
              fi
            done

  post-build-tasks:
    executor: machine-executor-amd64
    environment:
      IMAGE_REPO: igorferreir4/traefik-http-provider
    working_directory: ~/project/containers/traefik-http-provider/1.0.0
    steps:
      - checkout:
          path: ~/project
      - run:
          name: Install Trivy (optimized)
          command: |
            echo "Installing Trivy..."
            wget -qO trivy.tar.gz https://github.com/aquasecurity/trivy/releases/download/v0.48.3/trivy_0.48.3_Linux-64bit.tar.gz
            tar zxf trivy.tar.gz
            sudo mv trivy /usr/local/bin/
            trivy --version
      - run:
          name: Security scan with Trivy
          command: |
            echo "Scanning regular image..."
            trivy image --severity HIGH,CRITICAL --exit-code 0 $IMAGE_REPO:latest
            echo ""
            echo "Scanning alpine image..."
            trivy image --severity HIGH,CRITICAL --exit-code 0 $IMAGE_REPO:latest-alpine
      - run:
          name: Update Docker Hub README
          command: |
            echo "Preparing README content..."
            README_CONTENT=$(jq -Rs '.' ../README.md)
            
            if [ $? -ne 0 ]; then
              echo "✗ Error processing README with jq"
              exit 1
            fi
            
            echo "Authenticating with Docker Hub..."
            PAYLOAD="username=$DOCKERHUB_USERNAME&password=$DOCKERHUB_PASSWORD"
            JWT=$(curl -s -d "$PAYLOAD" https://hub.docker.com/v2/users/login/ | jq -r .token)
            
            if [ -z "$JWT" ] || [ "$JWT" = "null" ]; then
              echo "✗ Failed to authenticate with Docker Hub"
              exit 1
            fi
            
            echo "Updating README..."
            HEADER="Authorization: JWT $JWT"
            URL="https://hub.docker.com/v2/repositories/$IMAGE_REPO/"
            
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
              -X PATCH \
              -H "$HEADER" \
              -H 'Content-type: application/json' \
              --data "{\"full_description\": $README_CONTENT}" \
              $URL)
            
            if [ $STATUS -eq 200 ]; then
              echo "✓ README updated successfully!"
            else
              echo "✗ Failed to update README (HTTP $STATUS)"
              exit 1
            fi

workflows:
  traefik-http-provider-v1_0_0-workflow:
    when: 
      or: 
        - << pipeline.parameters.build-and-push >>
        - << pipeline.parameters.run-all >>  
    jobs:
      - build-cache-amd64
      - build-cache-arm64
      - build-multi-arch:
          requires:
            - build-cache-amd64
            - build-cache-arm64
      - build-cache-amd64-alpine
      - build-cache-arm64-alpine
      - build-multi-arch-alpine:
          requires:
            - build-cache-amd64-alpine
            - build-cache-arm64-alpine
      - post-build-tasks:
          requires:
            - build-multi-arch
            - build-multi-arch-alpine          
