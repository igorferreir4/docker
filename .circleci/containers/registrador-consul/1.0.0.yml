version: 2.1

executors:
  machine-executor-amd64:
    machine:
      image: ubuntu-2204:current
    resource_class: medium

  machine-executor-arm64:
    machine:
      image: ubuntu-2204:current
    resource_class: arm.medium

parameters:
  build-and-push:
    type: boolean
    default: false
  run-all:
    type: boolean
    default: false

commands:
  setup-qemu:
    steps:
      - run:
          name: Setup Qemu
          command: |
            docker run --privileged --rm tonistiigi/binfmt --install all
      - run:
          name: Create builder
          command: |
            docker buildx create --name multi-arch-build --bootstrap --use
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login --username $DOCKERHUB_USERNAME --password-stdin

  test-image:
    parameters:
      image_name:
        type: string
      platform:
        type: string
        default: ""
    steps:
      - run:
          name: Test Docker image
          command: |
            set -euo pipefail

            PLATFORM_FLAG=""
            if [ -n "<< parameters.platform >>" ]; then
              PLATFORM_FLAG="--platform << parameters.platform >>"
            fi
            
            echo "Testing image << parameters.image_name >>..."
            docker network create teste
            docker run --name consul2 --network=teste -d hashicorp/consul:1.22 agent -server -bootstrap-expect=1 -client=0.0.0.0
            sleep 5

            docker run --name registrador --network=teste -v /var/run/docker.sock:/var/run/docker.sock:ro -d $PLATFORM_FLAG << parameters.image_name >>
            sleep 5

            echo "Checking registrador logs..."
            if docker logs registrador 2>&1 | grep -q "Iniciando resync completo"; then
              echo "✓ Encontrou log 'Iniciando resync completo'"
            else
              echo "✗ Log esperado não encontrado"
              docker logs registrador || true
              exit 1
            fi

jobs:
  registrador-consul-v1_0_0-cache-amd64:
    executor: machine-executor-amd64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_TAG: registrador-consul-1.0.0-amd64
      CACHE_TAG_OLD: registrador-consul-1.0.0-amd64
    working_directory: ~/project/containers/registrador-consul/1.0.0
    steps:
      - checkout:
          path: ~/project
      - setup-qemu
      - run:
          name: Build docker image (amd64 cache)
          command: |
            docker buildx build \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_TAG_OLD" \
              --cache-from="$CACHE_REPO:$CACHE_TAG" \
              --cache-to=type=registry,ref=$CACHE_REPO:$CACHE_TAG,mode=max \
              --platform=linux/amd64 \
              --load \
              -t app:amd64 .
      - test-image:
          image_name: "app:amd64"
          platform: "linux/amd64"

  registrador-consul-v1_0_0-cache-arm64:
    executor: machine-executor-arm64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_TAG: registrador-consul-1.0.0-arm64
      CACHE_TAG_OLD: registrador-consul-1.0.0-arm64
    working_directory: ~/project/containers/registrador-consul/1.0.0
    steps:
      - checkout:
          path: ~/project
      - setup-qemu
      - run:
          name: Build docker image (arm64 cache)
          command: |
            docker buildx build \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_TAG_OLD" \
              --cache-from="$CACHE_REPO:$CACHE_TAG" \
              --cache-to=type=registry,ref=$CACHE_REPO:$CACHE_TAG,mode=max \
              --platform=linux/arm64/v8 \
              --load \
              -t app:arm64 .
      - test-image:
          image_name: "app:arm64"
          platform: "linux/arm64/v8"

  registrador-consul-v1_0_0-build-multi-arch:
    executor: machine-executor-amd64
    environment:
      CACHE_REPO: igorferreir4/buildcaches
      CACHE_AMD64: registrador-consul-1.0.0-amd64
      CACHE_ARM64: registrador-consul-1.0.0-arm64
      IMAGE_REPO: igorferreir4/registrador-consul
      IMAGE_TAGS: 1.0.0,latest
    working_directory: ~/project/containers/registrador-consul/1.0.0
    steps:
      - checkout:
          path: ~/project
      - setup-qemu
      - run:
          name: Build and push multi-arch image
          command: |
            TAGS=""
            for tag in $(echo $IMAGE_TAGS | tr "," " "); do
              TAGS="$TAGS -t $IMAGE_REPO:$tag"
            done
            
            echo "Building tags: $TAGS"
            
            docker buildx build \
              --build-arg BUILDKIT_INLINE_CACHE=0 \
              --cache-from="$CACHE_REPO:$CACHE_AMD64" \
              --cache-from="$CACHE_REPO:$CACHE_ARM64" \
              --push \
              --platform=linux/amd64,linux/arm64/v8 \
              $TAGS .
      - run:
          name: Verify pushed images
          command: |
            echo "Verifying images were pushed successfully..."
            for tag in $(echo $IMAGE_TAGS | tr "," " "); do
              echo "Checking $IMAGE_REPO:$tag"
              docker manifest inspect $IMAGE_REPO:$tag > /dev/null
              if [ $? -eq 0 ]; then
                echo "✓ $IMAGE_REPO:$tag exists"
              else
                echo "✗ $IMAGE_REPO:$tag not found"
                exit 1
              fi
            done
      - run:
          name: Security scan with Trivy
          command: |
            echo "Installing Trivy..."
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install -y trivy
            
            echo "Scanning image for vulnerabilities..."
            trivy image --severity HIGH,CRITICAL --exit-code 0 $IMAGE_REPO:latest
      - run:
          name: Update Docker Hub README
          command: |
            echo "Preparing README content..."
            README_CONTENT=$(jq -Rs '.' ../README.md)
            
            if [ $? -ne 0 ]; then
              echo "✗ Error processing README with jq"
              exit 1
            fi
            
            echo "Authenticating with Docker Hub..."
            PAYLOAD="username=$DOCKERHUB_USERNAME&password=$DOCKERHUB_PASSWORD"
            JWT=$(curl -s -d "$PAYLOAD" https://hub.docker.com/v2/users/login/ | jq -r .token)
            
            if [ -z "$JWT" ] || [ "$JWT" = "null" ]; then
              echo "✗ Failed to authenticate with Docker Hub"
              exit 1
            fi
            
            echo "Updating README..."
            HEADER="Authorization: JWT $JWT"
            URL="https://hub.docker.com/v2/repositories/$IMAGE_REPO/"
            
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
              -X PATCH \
              -H "$HEADER" \
              -H 'Content-type: application/json' \
              --data "{\"full_description\": $README_CONTENT}" \
              $URL)
            
            if [ $STATUS -eq 200 ]; then
              echo "✓ README updated successfully!"
            else
              echo "✗ Failed to update README (HTTP $STATUS)"
              exit 1
            fi

workflows:
  registrador-consul-v1_0_0-workflow:
    when: 
      or: 
        - << pipeline.parameters.build-and-push >>
        - << pipeline.parameters.run-all >>  
    jobs:
      - registrador-consul-v1_0_0-cache-amd64
      - registrador-consul-v1_0_0-cache-arm64
      - registrador-consul-v1_0_0-build-multi-arch:
          requires:
            - registrador-consul-v1_0_0-cache-amd64
            - registrador-consul-v1_0_0-cache-arm64